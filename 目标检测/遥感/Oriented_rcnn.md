# Oriented R-CNN for Object Detection

[**网络总结**](#网络总结)  
[**0.摘要 Abstract**](#0.摘要Abstract)  
[**1.介绍 Introduction**](#1.介绍Introduction)  
[**2.相关工作 Related work**](#2.相关工作Relatedwork)  
[**3.网络结构**](#3.网络结构)  
[**4.实验 Experiments**](#4.实验Experiments)  
[**5.结论 Conclusion**](#5.结论Conclusion)  



## 网络总结
参考博文链接：  
参考视频链接：  
源码链接：  
论文链接：  https://arxiv.org/pdf/2108.05699.pdf

<a id="0.摘要Abstract"></a>
## 0.摘要 Abstract
目前最先进的两阶段检测器通过耗时的方案生成定向提议，这减缓了检测器的速度，从而成为先进的定向物体检测系统中的计算瓶颈。本文提出了一个有效和简单的定向物体检测框架，称为定向R-CNN，它是一种具有良好准确性和高效性的通用两阶段定向检测器。具体而言，在第一阶段中，我们提出了一个定向区域建议网络（定向RPN），以近乎成本为零的方式直接生成高质量的定向提议。第二阶段是用于细化定向感兴趣区域（定向RoIs）并识别它们的定向R-CNN头。没有技巧的情况下，使用ResNet50的定向R-CNN在两个常用的定向物体检测数据集（包括DOTA（75.87％ mAP）和HRSC2016（96.50％ mAP））上实现了最先进的检测精度，在单个RTX 2080Ti上在图像大小为1024×1024的情况下的速度为15.1 FPS。我们希望我们的工作能够启发重新思考定向检测器的设计，并作为定向物体检测的基线。代码可在https://github.com/jbwang1997/OBBDetection上找到。

<a id="1.介绍Introduction"></a>
## 1.介绍 Introduction
大多数现有的最先进的定向物体检测方法[7, 37, 41]依赖于基于提议的框架，如Fast/Faster R-CNN [11, 10, 32]。它们涉及两个关键步骤：(i) 生成定向提议，(ii) 对提议进行细化并将其分类到不同的类别中。然而，生成定向提议的步骤在计算上是昂贵的。  

早期生成定向提议的方法之一是旋转的区域建议网络（简称为旋转RPN）[26]，它在每个位置放置了54个具有不同角度、尺度和长宽比的锚点，如图1(a)所示。引入旋转锚点提高了召回率，并在定向物体稀疏分布时表现良好。然而，大量的锚点导致了巨大的计算和内存占用。为了解决这个问题，RoI Transformer [7]通过复杂的过程从水平RoIs中学习定向提议，该过程涉及RPN、RoI对齐和回归（见图1(b)）。RoI Transformer方案提供了有希望的定向提议，并大幅减少了旋转锚点的数量，但也带来了昂贵的计算成本。现在，如何设计一个优雅而高效的解决方案来生成定向提议是突破现有最先进的定向检测器计算瓶颈的关键。

为了进一步推动技术的发展，我们调查了为什么基于提议的定向检测器的效率迄今为止还不够高。我们观察到，阻碍提议驱动检测器速度的主要障碍来自提议生成阶段。一个自然而直观的问题是：我们能否设计一个通用而简单的定向区域建议网络（简称为定向RPN），直接生成高质量的定向提议呢？在这个问题的推动下，本文提出了一种简单的双阶段定向物体检测框架，称为定向R-CNN，它在检测准确性方面达到了最先进的水平，同时与单阶段定向检测器相比保持了竞争力的效率。

具体而言，在定向R-CNN的第一阶段，我们提出了一个概念上简单的定向RPN（见图1(c)）。我们的定向RPN是一种轻量级的全卷积网络，其参数数量比旋转RPN和RoI Transformer+要少得多，从而降低了过拟合的风险。我们通过将RPN回归分支的输出参数数量从四个改变为六个来实现这一点。然而，没有免费的午餐。定向RPN的设计受益于我们提出的定向物体表示方案，称为中点偏移表示。对于图像中的任意定向物体，我们利用六个参数来表示它们。中点偏移表示继承了水平回归机制，并为预测定向提议提供了有界约束。定向R-CNN的第二阶段是定向R-CNN检测头：通过旋转的RoI对齐提取每个定向提议的特征，并进行分类和回归。

在没有华而不实的装饰下，我们在两个流行的定向物体检测基准数据集DOTA和HRSC2016上评估了我们的定向R-CNN方法。我们使用ResNet-50-FPN网络，在所有现有最先进的检测器中，达到了最高的准确性，DOTA数据集上达到了75.87%的mAP，HRSC2016数据集上达到了96.50%的mAP，同时在单个RTX 2080Ti上以1024×1024的图像尺寸运行时的帧率为15.1 FPS。因此，定向R-CNN在准确性和效率两方面都是一个实用的物体检测框架。我们希望我们的方法能够启发对定向物体检测器和定向物体回归方案设计的重新思考，并作为定向物体检测的稳定基准。关于未来的研究，我们的代码可在https://github.com/jbwang1997/OBBDetection上获取。

<a id="2.相关工作Relatedwork"></a>
## 2.相关工作 Related work
在过去的十年中，物体检测领域取得了显著进展[23, 33, 2, 42, 31, 24, 45, 13, 20, 29]。作为物体检测的一个延伸分支，定向物体检测 [7, 37, 26, 12, 5, 28]由于其广泛的应用而受到了广泛关注。  

依赖于水平边界框的通用物体检测方法（如Faster R-CNN）无法紧密地定位图像中的定向物体，因为水平边界框可能包含更多的背景区域或多个物体。这导致了最终分类置信度和定位准确性之间的不一致。为了解决这个问题，人们已经付出了很多努力。例如，夏等人 [36]构建了一个带有定向注释的大规模物体检测基准数据集，名为DOTA。许多现有的定向物体检测器 [7, 37, 41, 26, 25, 18]主要基于典型的基于提议的物体检测框架。对于定向物体，一种自然的解决方案是设置旋转的锚点 [26, 25]，例如旋转RPN [26]，其中不同角度、尺度和长宽比的锚点被放置在每个位置上。这些密集的旋转锚点导致了大量的计算和内存占用。  

为了减少旋转锚点的数量并降低特征与物体之间的不匹配，Ding等人[7]提出了RoI transformer方法，它从RPN生成的水平RoIs中学习旋转RoIs。这种方法极大地提高了定向物体检测的准确性。然而，这使得网络变得沉重和复杂，因为它涉及到全连接层和RoI对齐操作来学习旋转RoIs。为了解决小型、混乱、旋转物体检测的挑战，Yang等人[41]在Faster R-CNN的通用物体检测框架上建立了一种定向物体检测方法。Xu等人[37]提出了一种新的定向物体表示，称为滑动顶点。它通过在Faster R-CNN头部回归分支上学习四个顶点滑动偏移量来实现定向物体检测。然而，这两种方法仍然采用水平RoIs来执行分类和定向边界框回归，仍然存在严重的物体和特征之间的不对齐问题。  

此外，一些工作[12、28、39、27、43、16、40、47、15]探索了单阶段或无锚点的定向物体检测框架：输出物体类别和定向边界框，而不涉及区域提议生成和RoI对齐操作。例如，Yang等人[39]提出了一种改进的单阶段定向物体检测器，包括特征改进和渐进回归两个关键改进，以解决特征不对齐问题。Ming等人[27]基于RetinaNet [22]设计了一种新的标签分配策略，用于单阶段定向物体检测。它通过新的匹配策略动态地分配正或负锚点。Han等人[12]提出了一种单镜头对齐网络(S2ANet)用于定向物体检测。S2ANet旨在通过深度特征对齐来缓解分类得分和位置精度之间的不一致性。Pan等人[28]基于无锚点物体检测方法CenterNet [46]设计了一个动态精炼网络(DRN)用于定向物体检测。  

与上述方法相比，我们的工作属于建议型定向物体检测方法。它专注于设计一个高效的定向RPN，以打破生成定向提议的计算瓶颈。  

<a id="3.网络结构"></a>
## 3.网络结构
我们提出的物体检测方法被称为定向R-CNN，它由一个定向RPN和一个定向RCNN头部组成（见图2）。它是一个两阶段检测器，第一阶段以几乎零成本的方式生成高质量的定向提议，第二阶段是定向RCNN头部用于提议分类和回归。我们的FPN主干遵循[21]，产生五个级别的特征{P2，P3，P4，P5，P6}。为简单起见，我们没有显示定向RPN中的FPN架构以及分类分支。接下来，我们详细描述定向RPN和定向R-CNN头部。 

<a id="3.1OrientedRPN"></a>
### 3.1 Oriented RPN
对于任何尺寸的输入图像，定向RPN输出一组稀疏的定向提议。整个过程可以通过轻量级全卷积网络来建模。具体来说，它将FPN的五个特征级别{P2，P3，P4，P5，P6}作为输入，并为每个特征级别附加相同设计的头部（一个3×3卷积层和两个兄弟1×1卷积层）。我们在所有特征级别的每个空间位置上分配三个水平锚点，其中包括三个长宽比{1:2，1:1，2:1}的锚点。锚点在{P2，P3，P4，P5，P6}上具有像素面积为322、642、1282、2562、5122。每个锚点a用一个4维向量a=(ax,ay,aw,ah)表示，其中(ax,ay)是锚点的中心坐标，aw和ah表示锚点的宽度和高度。两个兄弟1×1卷积层中的一个是回归分支：输出相对于锚点的提议偏移δ=(δx，δy，δw，δh，δα，δβ)。在特征图的每个位置，我们生成A个提议（A是每个位置的锚点数量，并且在本文中等于3），因此回归分支具有6A个输出。通过解码回归输出，我们可以获得定向提议。解码过程如下所述：
![image](https://github.com/Cloud-Jowen/CVPaper_Note/assets/56760687/808cde38-16f5-445c-a17a-0e0943e96f9c)

其中，(x，y)是预测提议的中心坐标，w和h是预测定向提议外部矩形框的宽度和高度。∆α和∆β是相对于外部矩形框顶部和右侧中点的偏移量。最后，我们根据(x，y，w，h，∆α，∆β)产生定向提议。

另一个兄弟卷积层估计每个定向提议的物体得分。为了清晰地说明，我们在图2中省略了得分分支。定向RPN实际上是一种自然而直观的想法，但其关键在于定向物体的表示方式。在这种情况下，我们设计了一种新的简单的定向物体表示方案，称为中点偏移表示法。

#### 3.1.1 Midpoint Offset Representation
我们提出了一种新的定向物体表示方案，称为中点偏移表示法，如图3所示。黑点表示水平框每条边的中点，这是定向边界框O的外接矩形。橙色点表示定向边界框O的顶点。

具体而言，我们使用具有六个参数O = (x，y，w，h，∆α，∆β)的定向边界框O来表示通过公式（1）计算得到的物体。通过这六个参数，我们可以对于每个提议获得四个顶点的坐标集合v = (v1，v2，v3，v4)。这里，∆α是v1相对于水平框顶部的中点(x，y - h/2)的偏移量。根据对称性，-∆α表示v3相对于底部中点(x，y + h/2)的偏移量。∆β表示v2相对于右侧中点(x + w/2，y)的偏移量，-∆β表示v4相对于左侧中点(x - w/2，y)的偏移量。因此，四个顶点的坐标可以表示如下：
![image](https://github.com/Cloud-Jowen/CVPaper_Note/assets/56760687/1df87968-1355-4ef8-901f-3fb83afd50ec)

通过这种表示方式，我们通过预测外部矩形的参数（x，y，w，h）并推断中点偏移的参数（∆α，∆β），对每个定向提议进行回归。

#### 3.1.2 Loss Function
为了训练定向RPN，我们定义正样本和负样本如下。首先，给每个锚点分配一个二元标签p∗ ∈ {0, 1}。其中，0和1表示该锚点属于负样本或正样本。具体而言，我们将满足以下条件之一的锚点视为正样本：（i）与任何真实边界框的IoU重叠大于0.7；（ii）与真实边界框的IoU重叠最高且大于0.3。当锚点与真实边界框的IoU小于0.3时，将其标记为负样本。那些既不是正样本也不是负样本的锚点被视为无效样本，在训练过程中被忽略。值得注意的是，上述的真实边界框指的是定向边界框的外接矩形。

接下来，我们定义损失函数L1如下：
![image](https://github.com/Cloud-Jowen/CVPaper_Note/assets/56760687/371e1866-14b6-453d-9e52-5b0456aa8b22)

这里，i是锚点的索引，N（默认为N=256）是一个小批量样本中的总样本数。p∗i是第i个锚点的实际标签。pi是定向RPN分类分支的输出，表示提议属于前景的概率。t∗i是相对于第i个锚点的真实边界框的监督偏移量，是一个参数化的6维向量t∗i = (t∗x, t∗y, t∗w, t∗h, t∗α, t∗β)，来自于定向RPN回归分支的输出，表示相对于第i个锚点的预测提议的偏移量。Fcls是交叉熵损失函数。Freg是平滑L1损失函数。对于框回归（参见图4），我们采用仿射变换，其公式如下：
![image](https://github.com/Cloud-Jowen/CVPaper_Note/assets/56760687/f0fb56c3-68e8-4303-a473-899c511bf2d5)  

其中，(xg, yg)、wg和hg分别是外接矩形的中心坐标、宽度和高度。∆αg和∆βg是相对于上边和左边中点的偏移量，表示顶部和右侧顶点的位置偏移。

### 3.2 Oriented R-CNN Head
定向R-CNN头部接受特征图{P2，P3，P4，P5}和一组定向提议作为输入。对于每个定向提议，我们使用旋转的RoI对齐（简称为旋转RoIAlign）从其对应的特征图中提取一个固定大小的特征向量。每个特征向量经过两个全连接层（FC1和FC2，参见图2），然后是两个并行的全连接层：一个输出提议属于K+1类（K个目标类别加上1个背景类）的概率，另一个产生每个K个目标类别的提议偏移量。

#### 3.2.1 Rotated RoIAlign

<a id="4.实验Experiments"></a>
## 4.实验 Experiments

<a id="5.结论Conclusion"></a>
## 5.结论 Conclusion











